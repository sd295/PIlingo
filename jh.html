<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HLS Reconstruct & Play</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
      display: flex; justify-content: center; align-items: flex-start; gap: 30px;
    }
    .container {
      background-color: #ffffff; padding: 25px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%;
    }
    .playlist-container { max-width: 400px; flex-shrink: 0; }
    .player-container { max-width: 640px; }
    h2 { color: #1a1a1a; margin-top: 0; margin-bottom: 20px; text-align: center; }
    button {
      padding: 10px 20px; background-color: #007bff; color: white; border: none;
      border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s;
      width: 100%;
    }
    button:hover { background-color: #0056b3; }
    #playlist {
      list-style: none; padding: 0; margin-top: 20px;
      max-height: 450px; overflow-y: auto;
    }
    #playlist li a {
      display: block; padding: 12px 15px; background-color: #f8f9fa; border-radius: 5px;
      margin-bottom: 8px; text-decoration: none; color: #0056b3; font-weight: 500;
      transition: background-color 0.2s, color 0.2s; word-break: break-all;
    }
    #playlist li a:hover { background-color: #e9ecef; }
    #playlist li a .status { font-weight: normal; color: #6c757d; font-size: 0.8em; margin-left: 8px; }
    .player-controls { display: flex; gap: 10px; margin-bottom: 20px; }
    #url {
      flex-grow: 1; padding: 10px 15px; border: 1px solid #ccc;
      border-radius: 5px; font-size: 14px; background-color: #e9ecef;
    }
    #video { width: 100%; border-radius: 5px; background-color: #000; }
  </style>
</head>
<body>

  <div class="container playlist-container">
    <h2>Generated Playlist</h2>
    <button onclick="generateAndDisplayLinks()">Generate Links</button>
    <ul id="playlist">
      <!-- Generated links will be displayed here -->
    </ul>
  </div>

  <div class="container player-container">
    <h2>HLS Player</h2>
    <div class="player-controls">
      <input id="url" placeholder="Click a link on the left to play" readonly>
    </div>
    <video id="video" height="auto" controls></video>
  </div>

  <script>
    // --- Configuration ---
    const config = {
      apiDomain: "gc0zl0wc-3000.euw.devtunnels.ms",
      // --- NEW: Configuration for reconstructing the URL ---
      finalStreamDomain: "https://luminaplus.hu/en/player/proxy.php?url=", // The new domain to use
      finalStreamFilename: "index.m3u8",   // The new filename to append
      // ---
      
    };

    /**
     * Plays the HLS stream from the given URL.
     */
    function playHLS(url) {
      const video = document.getElementById("video");
      if (!url) { alert("Cannot play: M3U8 URL is empty."); return; }

      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => video.play());
      } else {
        alert("Your browser does not support HLS playback.");
      }
    }

    /**
     * Fetches the base URL, reconstructs it, and then plays it.
     */
    async function fetchAndPlay(apiUrl, linkElement) {
      const urlInput = document.getElementById('url');
      const statusSpan = linkElement.querySelector('.status');
      
      // Reset UI
      urlInput.value = 'Fetching stream info...';
      document.querySelectorAll('#playlist li a .status').forEach(s => s.textContent = '');
      statusSpan.textContent = '(loading...)';

      try {
        // Step 1: Fetch the base URL from your API.
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
        
        // Step 2: Get the base URL text from the response.
        const baseUrlFromApi = await response.text();
        if (!baseUrlFromApi || !baseUrlFromApi.startsWith('http')) {
          throw new Error("API response was not a valid URL.");
        }
        
        // --- ★ NEW LOGIC STARTS HERE ★ ---

        // Step 3: Extract the path from the received URL.
        const tempUrl = new URL(baseUrlFromApi.trim());
        const streamPath = tempUrl.pathname; // Example: "/a/b/c/"

        // Step 4: Construct the new URL with the new domain and filename.
        const reconstructedUrl = `https://${config.finalStreamDomain}${streamPath}${config.finalStreamFilename}`;
        
        // --- ★ NEW LOGIC ENDS HERE ★ ---

        // Step 5: Add the final  and play the video.
        const finalPlayableUrl = reconstructedUrl;
        urlInput.value = finalPlayableUrl;
        playHLS(finalPlayableUrl);

        statusSpan.textContent = '(Playing)';
        
      } catch (error) {
        console.error("Failed to fetch or play stream:", error);
        alert(`Could not load stream. Check browser console for details.\n\nError: ${error.message}`);
        statusSpan.textContent = '(Failed)';
        urlInput.value = 'Error loading stream.';
      }
    }

    /**
     * Generates a random IMDb-style 'tt' ID.
     */
    function generateImdbId() {
      const randomNumber = String(Math.floor(Math.random() * 9000000) + 1000000);
      return `tt${randomNumber}`;
    }

    /**
     * Generates 15 links and displays them in the playlist.
     */
    function generateAndDisplayLinks() {
      const playlist = document.getElementById('playlist');
      playlist.innerHTML = '';

      for (let i = 0; i < 15; i++) {
        const imdbId = generateImdbId();
        const apiUrl = `https://${config.apiDomain}/fetch-m3u8?imdb_ID=${imdbId}`;
        const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = "#";
        link.innerHTML = `${imdbId} <span class="status"></span>`;
        link.addEventListener('click', (event) => {
          event.preventDefault();
          fetchAndPlay(apiUrl, link);
        });
        listItem.appendChild(link);
        playlist.appendChild(listItem);
      }
    }
  </script>
</body>
</html>